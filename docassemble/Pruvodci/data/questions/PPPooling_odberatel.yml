metadata:
  title: |
    Odběratel – Platforma pro pooling 
  short title: |
    Odběratel
  description: |
    Přihlášení odběratele do platformy pro pooling
  revision_date: 2024-05-23
---
features:
  labels above fields: True
  question back button: True
  navigation back button: False
  progress bar: False
  hide standard menu: False
  navigation: True
  hide navbar: True
  css: uken.css
---
default screen parts:
  under: |
    % if show_save_resume_message:
    ${ action_button_html(url_action('save_and_resume'), label="Uložit a pokračovat později", color="secondary", size="sm", icon="floppy-disk") }
    % endif
---
sections:
  - uvod: Identifikační údaje
  - mista: Odběrná místa
  - vystup: Výstup
---
include:
  - objektPerson.yml
---
objects:
  - Info: DADict.using(gathered=True)
  - Odberatel: Person.using(nazev="odběratele")
  - OdberneMisto: DAObject
---
mandatory: True
code: |
  target = 'normal'
  show_save_resume_message = True
  multi_user = True
  nav.progressive = False
---
scan for variables: False
mandatory: True
code: |
  if target == 'save_and_resume':
    if wants_email:
      if email_sent:
        log("We sent an e-mail to your e-mail address.", "info")
      else:
        log("There was a problem with e-mailing.", "danger")
      show_save_resume_message = False
    undefine('wants_email')
    undefine('email_sent')
    target = 'normal'
  Odberatel.forma
  OdberneMisto.podkladSpotreby
  webhook_data
  hotovo
---
## KONEC SETUPU
question: |
  Vítejte v průvodci
subquestion: |
  *Nějaké úvodní informace*
fields:
  - "[Zásady zpracování osobních údajů](https://frankbold.org/zasady-ochrany-osobnich-udaju-frank-bold)": souhlas
    datatype: checkboxes
    minlength: 1
    choices:
      - "Souhlasím"
    validation messages:
      minlength: |
        Pro položení dotazu musíte se zásadami souhlasit.
continue button field: uvod
---
section: uvod
question: |
  Vaše identifikační údaje jakožto odběratele.
fields:
  - Typ osoby: Odberatel.forma
    input type: radio
    choices:
      - Právnická osoba: PO
      - Fyzická osoba: FO
  - Jméno a příjmení: Odberatel.name.text
    show if:
      variable: Odberatel.forma
      is: FO
  - Trvalé bydliště: Odberatel.address
    hint: Adresa
    show if:
      variable: Odberatel.forma
      is: FO
  - IČO: Odberatel.ic
    datatype: integer
    minlength: 8
    maxlength: 8
    show if:
      variable: Odberatel.forma
      is: PO
    hint: 12345678
    note: |
      <button id="doplnit" class="btn btn-primary">Doplnit údaje z OR</button>
  - Název organizace: Odberatel.name.text
    show if:
      variable: Odberatel.forma
      is: PO
  - Sídlo: Odberatel.address
    css class: addressAutocomplete
    show if:
      variable: Odberatel.forma
      is: PO
  - note: |
      **Zástupce společnosti**
    show if:
      variable: Odberatel.forma
      is: PO
  - Vaše jméno: Odberatel.zastupceName
    required: False
    show if:
      variable: Odberatel.forma
      is: PO
  - Vaše pozice v organizaci: Odberatel.zastupceFunkce
    required: False
    show if:
      variable: Odberatel.forma
      is: PO
  - E-mail: Odberatel.email
    datatype: email
  - Telefon: Odberatel.tel
css: |
  <link rel="stylesheet" href="${url_of('autocomplete.css')}">
script: |
  <script type="application/javascript" charset="utf-8">
    $("#doplnit").click(function(){
      action_call('doplnUdaje', {ico: val('Odberatel.ic')}, function(data){
        if (typeof data.test.firma !== 'undefined') {
        setField("Odberatel.name.text", data.test.firma);
        setField("Odberatel.ic", data.test.ico);
        setField("Odberatel.address", data.test.sidlo);
        } else if (typeof data.test == 'object') {
          action_perform('vyberFirmy')
        } else {
        flash(data.test, "danger")
        }
      });
      return false;
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@10.2.7/dist/autoComplete.min.js"></script>
  <script src="${url_of('mapy_api_suggestions.js')}"></script>
---
section: mista
question: |
  Informace o odběrných místech
subquestion: |
  Pokud máte více výroben, může pro vás být jednodušší zaslat nám je hromadně, než je vyplňovat ručně zde v rozhraní.

  Připravili jsme vzorový Excel s údaji, které potřebujeme. Můžete si jej stáhnout, vyplnit a tabulku nám zaslat.
fields:
  - Údaje o roční spotřebě – ideálně profil spotřeby (diagram): OdberneMisto.podkladSpotreby
    datatype: radio
    choices:  
      - "Nahraju soubor (faktura, diagram, či jiné)": soubor
      - "Nemám soubor, uvedu ručně": rucne
    default: soubor
  - Údaje o roční spotřebě - ideálně profil spotřeby (diagram): OdberneMisto.spotrebaFiles
    datatype: files
    show if:
      variable: OdberneMisto.podkladSpotreby
      is: soubor
  - Údaje o roční spotřebě - ideálně profil spotřeby (diagram): OdberneMisto.spotrebaRucne
    input type: area
    show if:
      variable: OdberneMisto.podkladSpotreby
      is: rucne
  - Vaše stávající cena silové elektřiny: OdberneMisto.stavajiciCena
    datatype: currency
    min: 0
    currency symbol: Kč/MWh
    required: False
  - "Chcete nám ještě více pomoci zajistit vám lepší nabídku zelené elektřiny? Vyplňte nám 3 další údaje…": OdberneMisto.extraInfo
    datatype: yesno
  - Typ vašeho stávajícího kontraktu na dodávku elektřiny: OdberneMisto.typKontraktu
    datatype: radio
    choices:
      - Fixovaná cena
      - Spotová cena
    show if: OdberneMisto.extraInfo
  - Požadovaná délka kontraktu na sdílení zelené elektříny (výběr z variant): OdberneMisto.delkaKontraktu
    choices:
      - 1–3 roky
      - 3–5 let
      - 5–10 let
      - 10–15 let
      - 15–25 let
    show if: OdberneMisto.extraInfo
  - Poptáváte i záruky původu elektřiny (zelené certifikáty)?: OdberneMisto.zarukaPuvodu
    datatype: yesno
    show if: OdberneMisto.extraInfo
---
event: save_and_resume
code: |
  target = 'save_and_resume'
---
code: |
  send_email(to=user_email_address, template=save_resume_template)
  email_sent = True
---
question: |
  Uložení formuláře na později
subquestion: |
  Na e-mail vám zašleme odkaz pod který můžete kdykoli pokračovat ve vyplňování formuláře.

  Odkaz je platný po dobu 30 dní.
fields:
  - no label: wants_email
    input type: radio
    choices:
      - "Dobře, pošlete mi e-mail": True
      - "Ne, děkuji": False
    default: True
  - E-mail address: user_email_address
    default: |
      ${email}
    datatype: email
    show if: wants_email
under: ""
---
event: autosave
code: |
  set_save_status('overwrite')
  for variable_name, variable_value in action_arguments().items():
    if variable_value:
      define(variable_name, variable_value)
---
template: save_resume_template
subject: |
  Váš formulář
content: |
  Pro pokračování ve formuláři, [klikněte zde](www.energie-pro-mesta.frankbold.org/nastroj?session=${ user_info().session }).
---
code: |
  variables = all_variables(make_copy=True)
  
  variables["files_links"] = []
  
  if defined("OdberneMisto.spotrebaFiles"):
    for file in OdberneMisto.spotrebaFiles:
      variables["files_links"].append(file.url_for(temporary=True,seconds=120))
---
code: |
  webhook_data = requests.post('https://hook.eu1.make.com/rppg9pv5vo3mtybkf6rpyphmsogj1soe', data=json.dumps(variables),headers={'Content-Type': 'application/json'})
---
event: hotovo
question: |
  Hotovo
subquestion: |
  Úspěšně odesláno.